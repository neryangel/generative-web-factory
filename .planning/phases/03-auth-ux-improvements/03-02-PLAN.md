---
phase: 03-auth-ux-improvements
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/components/auth/AuthForm.tsx
  - src/lib/auth-errors.ts
autonomous: false

must_haves:
  truths:
    - "User sees 'שכחתי סיסמה' link next to the password label when in signin mode"
    - "Clicking forgot password with a valid email sends a password reset email via Supabase and shows Hebrew success toast"
    - "Clicking forgot password with empty email shows Hebrew error toast prompting email entry"
    - "Forgot password link is NOT visible in signup mode"
    - "Rate limit error from Supabase (60-second cooldown) displays Hebrew message"
  artifacts:
    - path: "src/components/auth/AuthForm.tsx"
      provides: "Forgot password link and handler using Supabase resetPasswordForEmail"
      contains: "handleForgotPassword"
    - path: "src/lib/auth-errors.ts"
      provides: "Hebrew error mapping including password reset errors"
      contains: "resetPasswordForEmail"
  key_links:
    - from: "src/components/auth/AuthForm.tsx"
      to: "supabase.auth.resetPasswordForEmail"
      via: "direct Supabase client call"
      pattern: "resetPasswordForEmail"
    - from: "src/components/auth/AuthForm.tsx"
      to: "src/lib/auth-errors.ts"
      via: "getAuthErrorMessage for reset errors"
      pattern: "getAuthErrorMessage"
---

<objective>
Add a "forgot password" link to the login form that triggers Supabase's password reset email flow.

Purpose: Users who forget their password need a discoverable way to reset it directly from the login form, without navigating away. This uses Supabase's built-in resetPasswordForEmail which handles token generation, email delivery, and security (60-second rate limit). The link appears only in signin mode, positioned next to the password label where users expect it.

Output: Modified AuthForm.tsx with forgot password link + handler, updated auth-errors.ts with reset-specific error mappings.
</objective>

<execution_context>
@/Users/user/.claude/get-shit-done/workflows/execute-plan.md
@/Users/user/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-auth-ux-improvements/03-RESEARCH.md
@.planning/phases/03-auth-ux-improvements/03-01-SUMMARY.md

# Source files
@src/components/auth/AuthForm.tsx
@src/lib/auth-errors.ts
@src/integrations/supabase/client.ts
@src/hooks/useAuth.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add forgot password handler and link to AuthForm signin mode</name>
  <files>src/components/auth/AuthForm.tsx, src/lib/auth-errors.ts</files>
  <action>
    **Step 1: Update auth-errors.ts with reset-specific error mappings**

    Add these entries to the AUTH_ERROR_MAP in src/lib/auth-errors.ts:
    ```typescript
    'For security purposes, you can only request this after 60 seconds': 'מטעמי אבטחה, ניתן לנסות שוב בעוד 60 שניות',
    'User not found': 'לא נמצא משתמש עם כתובת אימייל זו',
    ```

    Note: The existing map already has the "once every 60 seconds" variant. Supabase may return slightly different wording, so add the "after 60 seconds" variant too. Do NOT remove any existing entries.

    **Step 2: Add supabase import to AuthForm.tsx**

    Add at the top of AuthForm.tsx, with the other imports:
    ```typescript
    import { supabase } from '@/integrations/supabase/client';
    ```

    This is needed for the direct `supabase.auth.resetPasswordForEmail()` call. The useAuth hook does not expose this method, and adding it to the hook is unnecessary complexity for a single use case.

    **Step 3: Add handleForgotPassword function to AuthForm component**

    Add this function inside the AuthForm component, after the handleSubmit function:
    ```typescript
    const handleForgotPassword = async () => {
      if (!email.trim()) {
        toast.error('יש להזין כתובת אימייל תחילה');
        return;
      }

      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: `${window.location.origin}/auth/reset-password`,
        });

        if (error) {
          toast.error(getAuthErrorMessage(error, 'שגיאה בשליחת קישור לאיפוס'));
        } else {
          toast.success('נשלח קישור לאיפוס סיסמה לכתובת האימייל');
        }
      } catch {
        toast.error('שגיאה בשליחת קישור לאיפוס');
      }
    };
    ```

    Notes on the redirectTo URL:
    - Uses `window.location.origin` for dynamic base URL (works in all environments)
    - The `/auth/reset-password` route does NOT exist yet in the app -- this is intentional. Supabase will redirect to this URL with tokens in the hash fragment. A future phase or task can create the actual reset password page. For now, the email sending works correctly regardless.
    - Do NOT create the reset password page in this plan. It's a separate concern.

    **Step 4: Modify the password label section to include forgot password link**

    Find the password field's label container. Currently it looks like:
    ```tsx
    <div className="space-y-2">
      <Label htmlFor="password">סיסמה</Label>
      ...
    </div>
    ```

    Replace the Label line with a flex container:
    ```tsx
    <div className="flex items-center justify-between">
      <Label htmlFor="password">סיסמה</Label>
      {mode === 'signin' && (
        <button
          type="button"
          onClick={handleForgotPassword}
          className="text-sm text-primary hover:underline"
        >
          שכחתי סיסמה
        </button>
      )}
    </div>
    ```

    This places the "שכחתי סיסמה" (forgot password) link on the same line as the password label, right-aligned (which in RTL means it appears on the left, opposite the label). It only shows in signin mode.

    **DO NOT:**
    - Navigate to a separate page -- handle reset inline with a toast
    - Add loading state for the reset operation (it's fast and a toast confirms)
    - Show the forgot password link in signup mode
    - Remove any existing auth-errors.ts entries
    - Modify the useAuth hook (use supabase client directly)
    - Create the /auth/reset-password page (out of scope for this plan)
  </action>
  <verify>
    - `npx tsc --noEmit` compiles clean
    - `npx vitest run` -- all tests pass (including auth-errors tests)
    - `npm run build` -- production build succeeds
    - AuthForm.tsx imports supabase from @/integrations/supabase/client
    - AuthForm.tsx has handleForgotPassword function
    - Forgot password link rendered only when mode === 'signin'
    - auth-errors.ts has reset-specific error mappings
    - handleForgotPassword checks for empty email before calling API
  </verify>
  <done>
    Forgot password link appears next to password label in signin mode only. Clicking it with a valid email calls Supabase resetPasswordForEmail and shows Hebrew success/error toast. Empty email shows prompt to enter email first. Rate limit errors display appropriate Hebrew message.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Auth UX improvements for Phase 03:
    1. Password visibility toggles on both password fields (Eye/EyeOff icons)
    2. HTML5 autocomplete attributes on all form fields (name, username, current-password, new-password)
    3. Form clearing when switching between signin and signup modes
    4. Forgot password link in signin mode with Supabase resetPasswordForEmail integration
    All in Hebrew/RTL layout.
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Navigate to the auth page

    **Test password visibility toggle:**
    3. Type a password -- verify Eye icon visible on the left side of the input
    4. Click the Eye icon -- verify password becomes visible (type="text"), icon changes to EyeOff
    5. Click EyeOff icon -- verify password is hidden again
    6. Switch to signup mode -- verify confirmation field also has its own toggle
    7. Toggle confirmation field visibility independently of main password field

    **Test autocomplete attributes (inspect in DevTools):**
    8. In signin mode: email has autocomplete="username", password has autocomplete="current-password"
    9. Switch to signup mode: full name has autocomplete="name", password has autocomplete="new-password", confirmation has autocomplete="new-password"

    **Test form clearing on mode switch:**
    10. In signin mode, type email and password
    11. Switch to signup mode -- verify all fields are cleared and password visibility is reset
    12. Type data in signup fields
    13. Switch back to signin mode -- verify all fields are cleared

    **Test forgot password:**
    14. In signin mode, verify "שכחתי סיסמה" link appears next to password label
    15. Click it without entering email -- verify error toast "יש להזין כתובת אימייל תחילה"
    16. Enter a valid email address, click "שכחתי סיסמה" -- verify success toast (or rate limit error if tested recently)
    17. Switch to signup mode -- verify forgot password link disappears

    **Test Phase 02 features still work:**
    18. In signup mode, verify password strength indicator and checklist still appear
    19. Verify confirmation match/mismatch feedback still works
    20. Verify submit gating still works (disabled until all rules pass + passwords match)
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the Auth UX improvements</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- TypeScript compiles clean
2. `npx vitest run` -- full test suite passes (442+ tests, zero regressions)
3. `npm run build` -- production build succeeds
4. Manual testing confirms all Phase 03 requirements:
   - UX-01: Loading states (already implemented, confirmed still working)
   - UX-02: Hebrew error messages (already implemented, confirmed still working)
   - UX-03: Forgot password link visible in signin mode with working Supabase integration
   - UX-04: Password visibility toggle on both password fields
   - UX-05: Form clearing on mode switch (all fields + UI state)
   - UX-06: Autocomplete attributes on all form inputs
5. Phase 02 features unaffected (strength indicator, checklist, confirmation, submit gating)
</verification>

<success_criteria>
- "שכחתי סיסמה" link visible in signin mode, hidden in signup mode
- Clicking forgot password with valid email calls Supabase and shows Hebrew success toast
- Clicking forgot password with empty email shows Hebrew prompt
- handleForgotPassword function uses Supabase resetPasswordForEmail directly
- auth-errors.ts has password reset error mappings
- All Phase 02 and Phase 01 features remain fully functional
- All tests pass, TypeScript clean, build succeeds
- User visually confirms the complete UX flow (checkpoint)
</success_criteria>

<output>
After completion, create `.planning/phases/03-auth-ux-improvements/03-02-SUMMARY.md`
</output>
